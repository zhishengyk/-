# 需求规格说明书

## 1. 项目背景
学校与科研场景中存在大量日志数据，传统按文件检索方式难以满足区间统计与对比分析需求。本项目通过线段树与可持久化快照，提供高效的区间统计、趋势分析与版本回溯能力。

## 2. 项目目标
1. 构建基于线段树的日志统计系统，支持日志导入、解析、统计与可视化。
2. 提供快照持久化与历史回滚能力，支持日级版本对比。
3. 实现权限控制与审计日志，满足安全与可追溯要求。

## 3. 使用范围与边界
1. 面向单机演示环境，日志规模为 10 万级以内。
2. 仅支持本地上传日志文件，不接入外部日志流系统。
3. 提供 HTTP API 与基础可视化页面，不强调复杂前端交互。

## 4. 角色与权限
1. 普通用户：登录、查询统计结果、查看趋势图。
2. 管理员：日志导入、用户管理、快照创建与回滚、报警规则配置、审计查询。

## 5. 功能性需求
### 5.1 日志采集与解析
1. 支持本地上传日志文件。
2. 支持 JSON 行与纯文本日志格式解析。
3. 抽取字段：时间戳、日志级别、状态码、响应时间、消息、来源。

### 5.2 线段树构建与实时更新
1. 以时间区间为索引构建线段树。
2. 日志导入后实时更新统计节点。
3. 节点统计内容包含：总量、级别分布、状态码分布、响应时间统计。

### 5.3 查询与统计
1. 区间日志查询，支持分页返回。
2. 区间统计汇总与可视化数据接口。
3. 性能指标统计：平均值、最大值、最小值。
4. 错误码趋势统计与时间桶划分。
5. 双区间对比分析，展示差异。

### 5.4 快照与版本管理
1. 支持每日自动快照。
2. 支持手动快照与快照列表查询。
3. 支持任意日期快照对比。
4. 支持快照回滚与恢复。

### 5.5 权限与安全
1. JWT 鉴权，未登录用户禁止访问核心接口。
2. 管理员与普通用户权限分离。
3. 所有关键操作记录审计日志。

### 5.6 日志监控与报警
1. 支持配置阈值规则，按状态码或总量触发。
2. 触发结果记录审计日志。

## 6. 非功能性需求
1. 可用性：单机环境可完成演示与答辩。
2. 性能：10 万级日志导入与统计在可接受时间内完成。
3. 可扩展性：可通过调整时间桶与索引范围支持更多日志。
4. 安全性：权限隔离与审计可追溯。

## 7. 数据需求与约束
1. 时间格式统一为 `yyyy-MM-dd HH:mm:ss`。
2. 日志级别字段默认值为 `INFO`。
3. 状态码默认值为 `200`。

## 8. 业务流程概述
1. 管理员登录并上传日志文件。
2. 系统解析日志并更新线段树统计。
3. 用户进行区间统计与趋势查询。
4. 管理员创建快照、对比与回滚。
5. 系统记录审计日志与报警事件。

## 9. 验收标准
1. 上传日志后统计结果正确，接口可正常返回。
2. 快照可创建、回滚与对比。
3. 权限与审计功能完整可用。
